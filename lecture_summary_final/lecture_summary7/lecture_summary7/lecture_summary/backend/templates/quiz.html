<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - عون</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='welcome.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='quiz.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Amiri';
            src: url('{{ url_for("static", filename="fonts/Amiri-Bold.ttf") }}') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        /* Subtle alive feel */
        .alive-bg {
            position: absolute;
            inset: -10% -10% -10% -10%;
            background: radial-gradient(40% 40% at 20% 30%, rgba(139,154,107,0.10) 0%, rgba(139,154,107,0.0) 60%),
                        radial-gradient(35% 35% at 80% 20%, rgba(74,91,42,0.10) 0%, rgba(74,91,42,0.0) 60%),
                        radial-gradient(45% 45% at 50% 80%, rgba(164,179,139,0.10) 0%, rgba(164,179,139,0.0) 60%);
            filter: blur(20px);
            animation: floatSoft 18s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: 0;
        }
        @keyframes floatSoft {
            0%   { transform: translate3d(0, 0, 0) scale(1); }
            50%  { transform: translate3d(10px, -12px, 0) scale(1.02); }
            100% { transform: translate3d(-8px, 10px, 0) scale(1.01); }
        }
        .pulse-soft {
            animation: pulseSoft 2.4s ease-in-out infinite;
        }
        @keyframes pulseSoft {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(107,124,74,0.25); }
            50%      { transform: scale(1.02); box-shadow: 0 8px 24px rgba(107,124,74,0.20); }
        }
        .btn {
            transition: transform .25s ease, box-shadow .25s ease, background .25s ease;
        }
        .btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body>
    <!-- Top navbar with logo (same style as other pages) -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="logo-icon">
                <span class="logo-text">عون</span>
            </div>
            <div class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-link">Back to Home</a>
            </div>
        </div>
    </nav>

    <!-- Clean boxed layout (calm card) -->
    <section class="hero-section" style="padding: 8rem 0 4rem; position: relative; overflow: hidden;">
        <div class="alive-bg"></div>
        <div class="hero-container" style="grid-template-columns: 1fr; position: relative; z-index: 1;">
            
            <!-- Loading Screen -->
            <div id="loadingScreen" class="card" style="max-width: 600px; margin: 0 auto; text-align: center;">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <h2 style="color: var(--primary-color); margin: 1rem 0;">Preparing Questions...</h2>
                    <p style="color: var(--text-light);">We're generating custom questions from your lecture content</p>
                </div>
            </div>

            <!-- Quiz Container -->
            <div id="quizContainer" class="card" style="max-width: 800px; margin: 0 auto; display: none;">
                <!-- Progress Indicator -->
                <div class="progress-container" style="margin-bottom: 2rem;">
                    <div class="progress-bar" style="background: rgba(107, 124, 74, 0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div id="progressFill" class="progress-fill" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <div class="progress-text" style="text-align: center; margin-top: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">5</span>
                    </div>
                </div>

                <!-- Question Card -->
                <div class="question-card">
                    <div class="question-header" style="margin-bottom: 2rem;">
                        <h2 id="questionText" style="font-size: 1.5rem; color: var(--primary-color); line-height: 1.6; text-align: center;">Question</h2>
                    </div>
                    
                    <div class="answers-container" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
                        <div class="answer-option" data-index="0" style="display: flex; align-items: center; padding: 1rem; background: rgba(250, 241, 230, 0.8); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                            <div class="answer-letter" style="width: 40px; height: 40px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-left: 1rem;">أ</div>
                            <div class="answer-text" id="answer0" style="flex: 1; color: var(--text-dark); font-size: 1.1rem;">الإجابة الأولى</div>
                        </div>
                        <div class="answer-option" data-index="1" style="display: flex; align-items: center; padding: 1rem; background: rgba(250, 241, 230, 0.8); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                            <div class="answer-letter" style="width: 40px; height: 40px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-left: 1rem;">ب</div>
                            <div class="answer-text" id="answer1" style="flex: 1; color: var(--text-dark); font-size: 1.1rem;">الإجابة الثانية</div>
                        </div>
                        <div class="answer-option" data-index="2" style="display: flex; align-items: center; padding: 1rem; background: rgba(250, 241, 230, 0.8); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                            <div class="answer-letter" style="width: 40px; height: 40px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-left: 1rem;">ج</div>
                            <div class="answer-text" id="answer2" style="flex: 1; color: var(--text-dark); font-size: 1.1rem;">الإجابة الثالثة</div>
                        </div>
                        <div class="answer-option" data-index="3" style="display: flex; align-items: center; padding: 1rem; background: rgba(250, 241, 230, 0.8); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                            <div class="answer-letter" style="width: 40px; height: 40px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-left: 1rem;">د</div>
                            <div class="answer-text" id="answer3" style="flex: 1; color: var(--text-dark); font-size: 1.1rem;">الإجابة الرابعة</div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="question-actions" style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 2rem;">
                        <button id="prevBtn" class="btn btn-secondary" style="display: none;">Previous</button>
                        <div style="flex: 1;"></div>
                        <button id="nextBtn" class="btn btn-primary" disabled>Next</button>
                        <button id="finishBtn" class="btn btn-primary" style="display: none;">Finish</button>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="card" style="max-width: 600px; margin: 0 auto; text-align: center; display: none;">
                <div class="error-content">
                    <h3 style="color: var(--accent-color); margin-bottom: 1rem;">❌ Error Occurred</h3>
                    <p id="errorText" style="color: var(--text-light); margin-bottom: 2rem;">We couldn't prepare the questions. Please try again.</p>
                    <button onclick="location.reload()" class="btn btn-primary">Retry</button>
                </div>
            </div>

            <!-- Results Screen -->
            <div id="resultsScreen" class="card" style="max-width: 800px; margin: 0 auto; display: none;">
                <div class="results-content">
                    <div class="results-header" style="text-align: center; margin-bottom: 2rem;">
                        <h2 id="resultsTitle" style="color: var(--primary-color); margin-bottom: 1rem;">Great Job!</h2>
                        <div class="score-display" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; padding: 1rem 2rem; border-radius: 12px; display: inline-block; margin-bottom: 1rem;">
                            <span id="scoreText" style="font-size: 1.5rem; font-weight: 600;">8/10</span>
                            <span id="percentageText" style="display: block; font-size: 0.9rem; opacity: 0.9;">80%</span>
                        </div>
                        <p id="resultsMessage" style="color: var(--text-light);">Excellent result! You've shown good understanding of the lecture.</p>
                    </div>

                    <div class="review-section" style="margin: 2rem 0;">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Question Review</h3>
                        <div id="questionsReview" class="questions-review" style="display: flex; flex-direction: column; gap: 1rem;">
                            <!-- Questions will be populated here -->
                        </div>
                    </div>

                    <div class="results-actions" style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                        <a href="{{ url_for('index') }}" class="btn btn-primary">Back to Home</a>
                        <button onclick="location.reload()" class="btn btn-secondary">Retry Quiz</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        let currentQuestionIndex = 0;
        let questions = [];
        let selectedAnswer = null;
        let totalQuestions = 0;
        let userAnswers = [];
        let correctAnswers = [];

        // Initialize quiz when page loads
        document.addEventListener('DOMContentLoaded', function() {
            generateQuiz();
        });

        async function generateQuiz() {
            try {
                const response = await fetch('/quiz/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.success) {
                    questions = data.questions;
                    totalQuestions = data.total_questions;
                    
                    // Hide loading screen and show quiz
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('quizContainer').style.display = 'block';
                    
                    // Update progress
                    updateProgress();
                    
                    // Show first question
                    showQuestion(0);
                } else {
                    showError(data.error || 'حدث خطأ غير متوقع');
                }
            } catch (error) {
                console.error('Error generating quiz:', error);
                showError('خطأ في الاتصال. يرجى التحقق من اتصال الإنترنت.');
            }
        }

        function showQuestion(index) {
            if (index >= questions.length) {
                // Quiz completed, show results
                showResults();
                return;
            }

            const question = questions[index];
            currentQuestionIndex = index;

            // Update question text
            document.getElementById('questionText').textContent = question.question;

            // Update answers
            for (let i = 0; i < 4; i++) {
                const answerElement = document.getElementById(`answer${i}`);
                const optionElement = document.querySelector(`[data-index="${i}"]`);
                
                if (i < question.answers.length) {
                    answerElement.textContent = question.answers[i];
                    optionElement.style.display = 'flex';
                } else {
                    optionElement.style.display = 'none';
                }
            }

            // Reset selection
            selectedAnswer = null;
            document.querySelectorAll('.answer-option').forEach(option => {
                option.classList.remove('selected');
                option.style.border = '2px solid transparent';
                option.style.background = 'rgba(250, 241, 230, 0.8)';
            });
            
            // Update navigation buttons
            updateNavigationButtons();

            // Update progress
            updateProgress();
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishBtn');

            // Show/hide previous button
            if (currentQuestionIndex > 0) {
                prevBtn.style.display = 'inline-block';
            } else {
                prevBtn.style.display = 'none';
            }

            // Show/hide next/finish button
            if (currentQuestionIndex === totalQuestions - 1) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'inline-block';
                finishBtn.style.display = 'none';
            }

            // Disable next/finish if no answer selected
            const hasAnswer = selectedAnswer !== null;
            nextBtn.disabled = !hasAnswer;
            finishBtn.disabled = !hasAnswer;
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = totalQuestions;
        }

        function showError(message) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = message;
        }

        function showResults() {
            // Calculate score
            let correctCount = 0;
            for (let i = 0; i < questions.length; i++) {
                if (userAnswers[i] === questions[i].correct_index) {
                    correctCount++;
                }
            }

            const percentage = Math.round((correctCount / totalQuestions) * 100);
            
            // Update results display
            document.getElementById('scoreText').textContent = `${correctCount}/${totalQuestions}`;
            document.getElementById('percentageText').textContent = `${percentage}%`;
            
            // Set results message based on score
            let title, message;
            if (percentage >= 90) {
                title = 'Excellent!';
                message = 'Outstanding result! You\'ve shown deep understanding of the lecture.';
            } else if (percentage >= 70) {
                title = 'Very Good!';
                message = 'Good result! You\'ve understood most concepts correctly.';
            } else if (percentage >= 50) {
                title = 'Fair';
                message = 'Acceptable result. We recommend reviewing the lecture again.';
            } else {
                title = 'Needs Improvement';
                message = 'We recommend reviewing the lecture more carefully.';
            }
            
            document.getElementById('resultsTitle').textContent = title;
            document.getElementById('resultsMessage').textContent = message;

            // Generate questions review
            generateQuestionsReview();

            // Hide quiz and show results
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';
        }

        function generateQuestionsReview() {
            const reviewContainer = document.getElementById('questionsReview');
            reviewContainer.innerHTML = '';

            questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = question.correct_index;
                const isCorrect = userAnswer === correctAnswer;

                const reviewItem = document.createElement('div');
                reviewItem.style.cssText = `
                    padding: 1rem;
                    background: ${isCorrect ? 'rgba(107, 124, 74, 0.1)' : 'rgba(220, 38, 38, 0.1)'};
                    border: 1px solid ${isCorrect ? 'var(--primary-color)' : 'var(--accent-color)'};
                    border-radius: 8px;
                    margin-bottom: 0.5rem;
                `;

                reviewItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="color: var(--primary-color);">Question ${index + 1}</strong>
                        <span style="color: ${isCorrect ? 'var(--primary-color)' : 'var(--accent-color)'}; font-weight: 600;">
                            ${isCorrect ? '✓ Correct' : '✗ Wrong'}
                        </span>
                    </div>
                    <p style="color: var(--text-dark); margin-bottom: 0.5rem;">${question.question}</p>
                    <div style="font-size: 0.9rem;">
                        <div style="color: var(--text-light); margin-bottom: 0.25rem;">
                            Your Answer: ${question.answers[userAnswer] || 'No answer'}
                        </div>
                        <div style="color: var(--primary-color);">
                            Correct Answer: ${question.answers[correctAnswer]}
                        </div>
                    </div>
                `;

                reviewContainer.appendChild(reviewItem);
            });
        }

        // Answer selection with visual feedback
        document.querySelectorAll('.answer-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove previous selection
                document.querySelectorAll('.answer-option').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.style.border = '2px solid transparent';
                    opt.style.background = 'rgba(250, 241, 230, 0.8)';
                });

                // Select current option
                this.classList.add('selected');
                this.style.border = '2px solid var(--primary-color)';
                this.style.background = 'rgba(107, 124, 74, 0.1)';
                
                selectedAnswer = parseInt(this.dataset.index);
                updateNavigationButtons();
            });
        });

        // Previous button
        document.getElementById('prevBtn').addEventListener('click', function() {
            if (currentQuestionIndex > 0) {
                // Save current answer
                userAnswers[currentQuestionIndex] = selectedAnswer;
                showQuestion(currentQuestionIndex - 1);
            }
        });

        // Next button
        document.getElementById('nextBtn').addEventListener('click', function() {
            if (selectedAnswer !== null) {
                // Save current answer
                userAnswers[currentQuestionIndex] = selectedAnswer;
                showQuestion(currentQuestionIndex + 1);
            }
        });

        // Finish button
        document.getElementById('finishBtn').addEventListener('click', function() {
            if (selectedAnswer !== null) {
                // Save current answer
                userAnswers[currentQuestionIndex] = selectedAnswer;
                showResults();
            }
        });
    </script>
</body>
</html>
